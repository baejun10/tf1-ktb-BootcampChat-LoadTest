###################################
# Environment Variables
###################################
# Artilleryê°€ ë¶€í•˜ë¥¼ ì£¼ëŠ” ëŒ€ìƒ URL
export BASE_URL ?= https://chat.goorm-ktb-001.goorm.team

# ëŒ€ëŸ‰ ì±„íŒ…ë°œì†¡ ì‹œ, ë°œì†¡ë˜ëŠ” ë©”ì‹œì§€ ê°¯ìˆ˜
export MASS_MESSAGE_COUNT ?= 10

# ê° Scenario ì¤‘ê°„ì˜ Actionì— ëŒ€í•œ Timeout ì„¤ì • (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
export ACTION_TIMEOUT ?= 1000
export ACTION_TIMEOUT_SHORT ?= 500
export ACTION_TIMEOUT_LONG ?= 2000

# ê¸ˆì¹™ì–´ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)
export FORBIDDEN_WORDS ?= "b3sig78jv,9c0hej6x,lbl276sz"

# Artilleryì—ì„œ ë¶€í•˜í…ŒìŠ¤íŠ¸ ì„¤ì •
export PHASE1_DURATION ?= 5 # í•´ë‹¹ ì‹œê°„ ë‚´ì—
export PHASE1_ARRIVAL_COUNT ?= 1 # ëª‡ëª…ì˜ ê°€ìƒ ìœ ì €ë¥¼ ìƒì„±í• ê±´ì§€?

# ê²°ê³¼ ë¦¬í¬íŠ¸ (JSON/HTML) ì €ìž¥ ê²½ë¡œ
REPORT_DIR ?= reports
REPORT_BASENAME ?= latest
REPORT_FILE ?= $(REPORT_DIR)/$(REPORT_BASENAME)

verify-env:
	# Check Node.js installed
	@command -v node 2>&1 || { echo >&2 "âŒ Node.js is not installed. Please install Node.js to proceed."; exit 1; }

	# Check npx installed
	@command -v npx 2>&1 || { echo >&2 "âŒ npx is not installed. Please install Node.js (which includes npx) to proceed."; exit 1; }

	# Check Artillery Package Installed
	@npm list artillery 2>&1 || { echo >&2 "âŒ Artillery is not installed . Installing Artillery..."; npm install artillery; }

artillery:
	@echo "ðŸš€ Running basic head test ($(PHASE1_ARRIVAL_COUNT) users for $(PHASE1_DURATION)s)..."
	@mkdir -p $(REPORT_DIR)
	@REPORT_STEM="$(REPORT_FILE)-$$(date +%Y%m%d-%H%M%S)"; \
		echo "ðŸ“¡ Writing raw metrics to $$REPORT_STEM.json"; \
		npx artillery run artillery-config.yaml -o $$REPORT_STEM.json && \
		echo "ðŸ“Š Rendering dashboard to $$REPORT_STEM.html" && \
		node scripts/render-report.js $$REPORT_STEM.json $$REPORT_STEM.html && \
		{ if command -v open >/dev/null 2>&1; then open $$REPORT_STEM.html >/dev/null 2>&1; \
		elif command -v xdg-open >/dev/null 2>&1; then xdg-open $$REPORT_STEM.html >/dev/null 2>&1; fi; true; } && \
		echo "âœ… Dashboard available at $$REPORT_STEM.html"
