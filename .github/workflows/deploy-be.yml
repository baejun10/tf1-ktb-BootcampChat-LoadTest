name: Deploy Backend (Multi-Instance)

on:
  push:
    branches: [ "main", "feature/be-cicd" ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/**'
      - 'deploy.sh'
  workflow_dispatch:

jobs:
  # 1. IP ëª©ë¡ ì¡°íšŒ ë° JSON ë°°ì—´ ìƒì„± Job (ìˆœì°¨ ì‹¤í–‰)
  get_ips_list:
    runs-on: ubuntu-latest
    outputs:
      # ë³‘ë ¬ Jobì— ì „ë‹¬í•  IP ë¦¬ìŠ¤íŠ¸ (JSON í˜•ì‹)
      ips_json: ${{ steps.get-ips.outputs.ips_json }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ê³ ì • IP ëŒ€ì‹  íƒœê·¸ë¡œ 10ëŒ€ IP ì¡°íšŒ ë° JSON ë³€í™˜
      - name: Get EC2 Instances IPs and Format JSON
        id: get-ips
        run: |
          TAG_NAME="chat-backend"
          
          echo ">>> '$TAG_NAME' íƒœê·¸ë¥¼ ê°€ì§„ ì¸ìŠ¤í„´ìŠ¤ ê²€ìƒ‰..."
          
          # Private IPë¡œ ê²€ìƒ‰ (VPC ë‚´ í†µì‹ ì„ ìœ„í•´ Private IP ì‚¬ìš©ì„ ê¶Œì¥)
          IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=$TAG_NAME" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PrivateIpAddress" \
            --output text)
          
          if [ -z "$IPS" ]; then
            echo "Error: ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "Target IPs: $IPS"
          
          # ì¤„ë°”ê¿ˆëœ IP ëª©ë¡ì„ JSON ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ ì¶œë ¥ (ë³‘ë ¬ Jobìœ¼ë¡œ ì „ë‹¬)
          IPS_JSON=$(echo "$IPS" | tr '\t' '\n' | awk 'NF' | jq -R . | jq -s .)
          
          echo "ips_json=$IPS_JSON" >> $GITHUB_OUTPUT
          echo "âœ… IP ëª©ë¡ JSON ë³€í™˜ ì™„ë£Œ: $IPS_JSON"

  # 2. ë§¤íŠ¸ë¦­ìŠ¤ ì „ëµì„ ì´ìš©í•œ ë³‘ë ¬ ë°°í¬ Job
  parallel_deploy:
    needs: get_ips_list  # IP ëª©ë¡ ì¡°íšŒ Job ì™„ë£Œ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest

    # ë§¤íŠ¸ë¦­ìŠ¤ ì „ëµ ì •ì˜: IP í•˜ë‚˜ë‹¹ í•˜ë‚˜ì˜ Jobì„ ë³‘ë ¬ë¡œ ìƒì„±
    strategy:
      fail-fast: false # í•˜ë‚˜ì˜ Job ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ Jobì€ ê³„ì† ì§„í–‰
      matrix:
        ip: ${{ fromJson(needs.get_ips_list.outputs.ips_json) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ëª¨ë“  ë³‘ë ¬ Jobì—ì„œ JAR íŒŒì¼ ë¹Œë“œê°€ ì¤‘ë³µë˜ì–´ ì‹¤í–‰ë©ë‹ˆë‹¤.
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          dependency-path: 'apps/backend/pom.xml'

      - name: Build with Maven
        run: |
          cd apps/backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      # Deploy to Instance ${{ matrix.ip }}
      - name: Deploy to Instance ${{ matrix.ip }}
        env:
          SSH_KEY: ${{ secrets.SSH_PEM_KEY }}
          USER: ubuntu

          # [Secrets ì •ì˜] .env íŒŒì¼ì— ì£¼ì…í•  ëª¨ë“  Secrets/Variablesì„ ì—¬ê¸°ì— ì •ì˜
          MONGO_URI: ${{ secrets.MONGO_URI }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          S3_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          S3_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_PUBLIC_BASE_URL: ${{ vars.S3_PUBLIC_BASE_URL }}

          # ë³´ì•ˆ í‚¤ ë° ê¸°íƒ€ í™˜ê²½ ë³€ìˆ˜
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ENCRYPTION_SALT: ${{ secrets.ENCRYPTION_SALT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # ê³ ì • ê°’
          STORAGE_PROVIDER: s3
          CURRENT_IP: ${{ matrix.ip }} # í˜„ì¬ Jobì´ ë‹´ë‹¹í•˜ëŠ” IP

        run: |
          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          
          # [ë³€ê²½] for ë£¨í”„ ì—†ì´ ë‹¨ì¼ IP($CURRENT_IP)ì— ëŒ€í•´ ë°°í¬ ì‹¤í–‰
          echo "--------------------------------------------------"
          echo "ğŸš€ Deploying to $CURRENT_IP (Matrix Job) ..."
          echo "--------------------------------------------------"
          
          # A. JAR íŒŒì¼ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i key.pem \
            apps/backend/target/*.jar \
            $USER@$CURRENT_IP:/home/ubuntu/ktb-chat-backend/temp/app.jar
          
          # B. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i key.pem \
            apps/backend/deploy.sh \
            $USER@$CURRENT_IP:/home/ubuntu/ktb-chat-backend/temp/deploy.sh
          
          # C. ì›ê²© ëª…ë ¹ ì‹¤í–‰ (hosts ì„¤ì • + .env ìƒì„±/ì ìš© + ì‹¤í–‰)
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$CURRENT_IP "
            # 1. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° deploy.sh ì´ë™
            chmod +x /home/ubuntu/ktb-chat-backend/temp/deploy.sh && \
            mv /home/ubuntu/ktb-chat-backend/temp/deploy.sh /home/ubuntu/ktb-chat-backend/deploy.sh && \
          
            # 2. /etc/hosts ëª½ê³ ë””ë¹„ IP ìë™ ë“±ë¡
            if ! grep -q 'chat-mongodb-01' /etc/hosts; then
              echo '>>> [Auto-Config] MongoDB IP ë“±ë¡...'
              echo '10.0.101.147  chat-mongodb-01' | sudo tee -a /etc/hosts
              echo '10.0.101.206  chat-mongodb-02' | sudo tee -a /etc/hosts
              echo '10.0.101.249  chat-mongodb-03' | sudo tee -a /etc/hosts
            fi && \
          
            # 3. [í•µì‹¬] .env íŒŒì¼ ë‚´ìš© ì‘ì„± (Secrets ì£¼ì…)
            echo '>>> [Auto-Config] .env íŒŒì¼ ì¬ìƒì„± ë° Secrets ì£¼ì…...'
            cat << EOF | sudo tee /home/ubuntu/ktb-chat-backend/.env
          # ìŠ¤í† ë¦¬ì§€ í”„ë¡œë°”ì´ë” ì„ íƒ
          STORAGE_PROVIDER=$STORAGE_PROVIDER

          # ëª½ê³ ë””ë¹„ ì„¤ì •
          MONGO_URI=$MONGO_URI

          # ë ˆë””ìŠ¤ ì„¤ì •
          REDIS_HOST=$REDIS_HOST
          REDIS_PORT=6379

          # í¬íŠ¸ ì„¤ì •
          PORT=5001
          WS_PORT=5002

          # S3/CloudFront ì„¤ì •
          S3_BUCKET=${{ vars.S3_BUCKET }}
          S3_REGION=${{ secrets.AWS_REGION }}
          S3_ACCESS_KEY=$S3_ACCESS_KEY
          S3_SECRET_KEY=$S3_SECRET_KEY
          S3_PUBLIC_BASE_URL=${{ vars.S3_PUBLIC_BASE_URL }}
          S3_BASE_DIR=uploads
          S3_PRESIGN_EXPIRATION_SECONDS=900

          # ë³´ì•ˆ í‚¤ ë° API
          JWT_SECRET=$JWT_SECRET
          ENCRYPTION_KEY=$ENCRYPTION_KEY
          ENCRYPTION_SALT=$ENCRYPTION_SALT
          OPENAI_API_KEY=$OPENAI_API_KEY
          EOF
          
            # 4. ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ktb-chat ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í¬í•¨)
            /home/ubuntu/ktb-chat-backend/deploy.sh
          "
          
          if [ $? -eq 0 ]; then
            echo "âœ… $CURRENT_IP ë°°í¬ ì„±ê³µ"
          else
            echo "âŒ $CURRENT_IP ë°°í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          rm key.pem