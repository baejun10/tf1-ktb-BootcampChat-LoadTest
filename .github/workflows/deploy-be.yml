name: Deploy Backend (Dev/Single)

on:
  push:
    branches: [ "feature/be-cicd" ] # 또는 develop
    paths:
      - 'apps/backend/**'
      - '.github/workflows/deploy-dev.yml'
      - 'deploy.sh'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # Java 세팅 (모노레포 캐싱 경로 주의)
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        # [중요] pom.xml 위치를 알려줘야 캐싱이 동작함
        dependency-path: 'apps/backend/pom.xml'

    # Maven 빌드
    - name: Build with Maven
      run: |
        # 백엔드 폴더로 이동
        cd apps/backend
        chmod +x mvnw
        # 테스트 건너뛰고 빌드 (속도 최적화)
        ./mvnw clean package -DskipTests

    # 파일 전송 1: JAR 파일
    - name: Upload JAR to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BE_SSH_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PEM_KEY }}
        # 소스: apps/backend/target 안에 있는 jar
        source: "apps/backend/target/*.jar"
        target: "/home/ubuntu/ktb-chat-backend/temp"
        # [중요] 경로 껍질 3겹 벗기기 (apps -> backend -> target 제거)
        strip_components: 3

    # 파일 전송 2: 배포 스크립트
    - name: Upload Deploy Script
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BE_SSH_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PEM_KEY }}
        source: "apps/backend/deploy.sh"
        target: "/home/ubuntu/ktb-chat-backend/temp"

    # SSH 접속 및 스크립트 실행
    - name: Execute Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.BE_SSH_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PEM_KEY }}
        script: |
          chmod +x /home/ubuntu/ktb-chat-backend/temp/deploy.sh
          mv /home/ubuntu/ktb-chat-backend/temp/deploy.sh /home/ubuntu/ktb-chat-backend/deploy.sh
          /home/ubuntu/ktb-chat-backend/deploy.sh