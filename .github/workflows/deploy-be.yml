name: Deploy Backend (Multi-Instance)

on:
  push:
    branches: [ "main", "feature/be-cicd" ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/**'
      - 'deploy.sh'
  workflow_dispatch:

jobs:
  # 1. IP 목록 조회 및 JSON 배열 생성 Job (순차 실행)
  get_ips_list:
    runs-on: ubuntu-latest
    outputs:
      # 병렬 Job에 전달할 IP 리스트 (JSON 형식)
      ips_json: ${{ steps.get-ips.outputs.ips_json }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 고정 IP 대신 태그로 10대 IP 조회 및 JSON 변환
      - name: Get EC2 Instances IPs and Format JSON
        id: get-ips
        run: |
          TAG_NAME="chat-backend"
          
          echo ">>> '$TAG_NAME' 태그를 가진 인스턴스 검색..."
          
          IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=$TAG_NAME" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text)
          
          if [ -z "$IPS" ]; then
            echo "Error: 실행 중인 인스턴스가 없습니다!"
            exit 1
          fi
          
          echo "Target IPs: $IPS"
          
          IPS_JSON=$(echo "$IPS" | tr '\t' '\n' | awk 'NF' | jq -R . | jq -s -c .)
          
          # GitHub Actions의 출력 변수 설정 방식 변경: $GITHUB_OUTPUT 사용 (이미 적용됨)
          echo "ips_json=$IPS_JSON" >> $GITHUB_OUTPUT
          echo "✅ IP 목록 JSON 변환 완료: $IPS_JSON"

  # 2. 매트릭스 전략을 이용한 병렬 배포 Job
  parallel_deploy:
    needs: get_ips_list  # IP 목록 조회 Job 완료 후 실행
    runs-on: ubuntu-latest

    # 매트릭스 전략 정의: IP 하나당 하나의 Job을 병렬로 생성
    strategy:
      fail-fast: false # 하나의 Job 실패해도 나머지 Job은 계속 진행
      matrix:
        ip: ${{ fromJson(needs.get_ips_list.outputs.ips_json) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 모든 병렬 Job에서 JAR 파일 빌드가 중복되어 실행됩니다.
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          dependency-path: 'apps/backend/pom.xml'

      - name: Build with Maven
        run: |
          cd apps/backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      # Deploy to Instance ${{ matrix.ip }}
      - name: Deploy to Instance ${{ matrix.ip }}
        env:
          SSH_KEY: ${{ secrets.SSH_PEM_KEY }}
          USER: ubuntu

          # [Secrets 정의] .env 파일에 주입할 모든 Secrets/Variables을 여기에 정의
          MONGO_URI: ${{ secrets.MONGO_URI }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          S3_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          S3_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_PUBLIC_BASE_URL: ${{ vars.S3_PUBLIC_BASE_URL }}

          # 보안 키 및 기타 환경 변수
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ENCRYPTION_SALT: ${{ secrets.ENCRYPTION_SALT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # 고정 값
          STORAGE_PROVIDER: s3
          CURRENT_IP: ${{ matrix.ip }} # 현재 Job이 담당하는 IP

        run: |
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          
          echo "--------------------------------------------------"
          echo "🚀 Deploying to $CURRENT_IP (Matrix Job) ..."
          echo "--------------------------------------------------"
          
          # A. JAR 파일 전송
          scp -o StrictHostKeyChecking=no -i key.pem \
            apps/backend/target/*.jar \
            $USER@$CURRENT_IP:/home/ubuntu/ktb-chat-backend/temp/app.jar
          
          # B. 배포 스크립트 전송
          scp -o StrictHostKeyChecking=no -i key.pem \
            apps/backend/deploy.sh \
            $USER@$CURRENT_IP:/home/ubuntu/ktb-chat-backend/temp/deploy.sh
          
          # C. 원격 명령 실행
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$CURRENT_IP "
            # 1. 실행 권한 부여
            chmod +x /home/ubuntu/ktb-chat-backend/temp/deploy.sh && \
            mv /home/ubuntu/ktb-chat-backend/temp/deploy.sh /home/ubuntu/ktb-chat-backend/deploy.sh && \
          
            # 2. hosts 등록 (생략 가능하면 생략)
            if ! grep -q 'chat-mongodb-01' /etc/hosts; then
              echo '>>> [Auto-Config] MongoDB IP 등록...'
              echo '10.0.101.147  chat-mongodb-01' | sudo tee -a /etc/hosts
              echo '10.0.101.206  chat-mongodb-02' | sudo tee -a /etc/hosts
              echo '10.0.101.249  chat-mongodb-03' | sudo tee -a /etc/hosts
            fi && \
          
            # 3. [핵심 수정] 변수 값을 쌍따옴표(\")로 감싸서 .env 생성
            echo '>>> [Auto-Config] .env 파일 재생성...'
            cat << EOF | sudo tee /home/ubuntu/ktb-chat-backend/.env
          STORAGE_PROVIDER=\"$STORAGE_PROVIDER\"
          MONGO_URI=\"$MONGO_URI\"
          REDIS_HOST=\"$REDIS_HOST\"
          REDIS_PORT=6379
          PORT=5001
          WS_PORT=5002
          
          S3_BUCKET=\"$S3_BUCKET\"
          S3_REGION=\"${{ secrets.AWS_REGION }}\"
          S3_ACCESS_KEY=\"$S3_ACCESS_KEY\"
          S3_SECRET_KEY=\"$S3_SECRET_KEY\"
          S3_PUBLIC_BASE_URL=\"$S3_PUBLIC_BASE_URL\"
          S3_BASE_DIR=\"uploads\"
          S3_PRESIGN_EXPIRATION_SECONDS=900
          
          JWT_SECRET=\"$JWT_SECRET\"
          ENCRYPTION_KEY=\"$ENCRYPTION_KEY\"
          ENCRYPTION_SALT=\"$ENCRYPTION_SALT\"
          OPENAI_API_KEY=\"$OPENAI_API_KEY\"
          EOF
          
            # 4. 배포 스크립트 실행
            /home/ubuntu/ktb-chat-backend/deploy.sh
          "
          
          if [ $? -eq 0 ]; then
            echo "✅ $CURRENT_IP 배포 성공"
          else
            echo "❌ $CURRENT_IP 배포 실패"
            exit 1
          fi
          
          rm key.pem