name: Deploy Backend (Multi-Instance)

on:
  push:
    branches: [ "main", "feature/be-cicd" ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/**'
      - 'deploy.sh'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          dependency-path: 'apps/backend/pom.xml'

      - name: Build with Maven
        run: |
          cd apps/backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      #  AWS Ï†ëÏÜç Í∂åÌïú (IP Ï°∞ÌöåÏö©)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      #  Í≥†Ï†ï IP ÎåÄÏã† ÌÉúÍ∑∏Î°ú 10ÎåÄ IP Ï°∞Ìöå
      - name: Get EC2 Instances IPs
        id: get-ips
        run: |
          TAG_NAME="chat-backend"
          
          echo ">>> '$TAG_NAME' ÌÉúÍ∑∏Î•º Í∞ÄÏßÑ Ïù∏Ïä§ÌÑ¥Ïä§ Í≤ÄÏÉâ..."
          
          IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=$TAG_NAME" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text)
          
          if [ -z "$IPS" ]; then
            echo "Error: Ïã§Ìñâ Ï§ëÏù∏ Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§!"
            exit 1
          fi
          
          echo "Target IPs: $IPS"
          # Ï§ÑÎ∞îÍøàÏùÑ Í≥µÎ∞±ÏúºÎ°ú Î≥ÄÌôòÌï¥ÏÑú Ìïú Ï§ÑÎ°ú ÎßåÎì¶
          echo "ips=$(echo $IPS | tr '\n' ' ')" >> $GITHUB_OUTPUT

      # Ï°∞ÌöåÎêú IP Î™©Î°ùÏúºÎ°ú Loop ÎèåÎ©¥ÏÑú Î∞∞Ìè¨ (appleboy ÎåÄÏã† ÏßÅÏ†ë ssh/scp ÏÇ¨Ïö©)
      - name: Deploy to All Instances
        env:
          SSH_KEY: ${{ secrets.SSH_PEM_KEY }}
          USER: ubuntu
        run: |
          # SSH ÌÇ§ ÌååÏùº ÏÉùÏÑ±
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          
          # IP Î™©Î°ù Î∞∞Ïó¥Î°ú Î≥ÄÌôò
          IP_LIST=(${{ steps.get-ips.outputs.ips }})
          
          for ip in "${IP_LIST[@]}"; do
            echo "--------------------------------------------------"
            echo "üöÄ Deploying to $ip ..."
            echo "--------------------------------------------------"
          
            # A. JAR ÌååÏùº Ï†ÑÏÜ°
            # apps/backend/target/*.jar Í≤ΩÎ°úÎ•º ÏßÅÏ†ë ÏßÄÏ†ï (strip_components Î∂àÌïÑÏöî)
            scp -o StrictHostKeyChecking=no -i key.pem \
              apps/backend/target/*.jar \
              $USER@$ip:/home/ubuntu/ktb-chat-backend/temp/app.jar
          
            # B. Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†ÑÏÜ°
            # apps/backend/deploy.sh Í≤ΩÎ°úÎ•º ÏßÅÏ†ë ÏßÄÏ†ï
            scp -o StrictHostKeyChecking=no -i key.pem \
              apps/backend/deploy.sh \
              $USER@$ip:/home/ubuntu/ktb-chat-backend/temp/deploy.sh
          
            # C. ÏõêÍ≤© Î™ÖÎ†π Ïã§Ìñâ (hosts ÏÑ§Ï†ï + Ïã§Ìñâ)
            ssh -o StrictHostKeyChecking=no -i key.pem $USER@$ip "
              # 1. Ïã§Ìñâ Í∂åÌïú Î∂ÄÏó¨ Î∞è Ïù¥Îèô
              chmod +x /home/ubuntu/ktb-chat-backend/temp/deploy.sh && \
              mv /home/ubuntu/ktb-chat-backend/temp/deploy.sh /home/ubuntu/ktb-chat-backend/deploy.sh && \
          
              # 2. [ÌïÑÏàò] /etc/hosts Î™ΩÍ≥†ÎîîÎπÑ IP ÏûêÎèô Îì±Î°ù
              if ! grep -q 'chat-mongodb-01' /etc/hosts; then
                echo '>>> [Auto-Config] MongoDB IP Îì±Î°ù...'
                echo '10.0.101.147  chat-mongodb-01' | sudo tee -a /etc/hosts
                echo '10.0.101.206  chat-mongodb-02' | sudo tee -a /etc/hosts
                echo '10.0.101.249  chat-mongodb-03' | sudo tee -a /etc/hosts
              fi && \
          
              # 3. Ïã§Ï†ú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
              /home/ubuntu/ktb-chat-backend/deploy.sh
            "
          
            if [ $? -eq 0 ]; then
               echo "‚úÖ $ip Î∞∞Ìè¨ ÏÑ±Í≥µ"
            else
               echo "‚ùå $ip Î∞∞Ìè¨ Ïã§Ìå®"
               exit 1
            fi
          done
          rm key.pem